{"version":3,"file":"index.js","sources":["../lib/cache-promise.js","../lib/generate.js","../lib/route.js"],"sourcesContent":["import lruCache from 'lru-cache';\n\nexport const STATUS = {\n  initialized: 'initialized',\n  fetching: 'fetching',\n  fetched: 'fetched',\n  fetchFailed: 'fetch failed',\n};\n\nexport class CacheItem {\n  constructor(opts) {\n    this.key = opts.key;\n    this.value = opts.value;\n    this.fetchFunction = opts.fetchFunction;\n    this.init();\n  }\n\n  init(status = STATUS.initialized) {\n    this.status = status;\n    this.resolvers = [];\n    this.rejectors = [];\n    return this.rejectors;\n  }\n\n  fetch() {\n    return Promise.resolve().then(() => {\n      if (this.status === STATUS.fetchFailed) {\n        this.init();\n      }\n      if (this.status === STATUS.fetched || !this.fetchFunction) {\n        // Return the current value\n        return this.value;\n      }\n      // Add a promise to the list of promises awaiting fetch completion\n      const p = new Promise((resolve, reject) => {\n        this.resolvers.push(resolve);\n        return this.rejectors.push(reject);\n      });\n      if (this.status === STATUS.initialized) {\n        // Call the fetch function\n        this.status = STATUS.fetching;\n        Promise.resolve().then(() => this.fetchFunction(this.key)).then((value) => {\n          this.value = value;\n          this.status = STATUS.fetched;\n          const ref = this.resolvers;\n          const results = [];\n          for (let i = 0, len = ref.length; i < len; i++) {\n            const r = ref[i];\n            results.push(r(value));\n          }\n          this.init(this.status);\n          return results;\n        }).catch((err) => {\n          this.status = STATUS.fetchFailed;\n          const ref = this.rejectors;\n          const results = [];\n          for (let i = 0, len = ref.length; i < len; i++) {\n            const r = ref[i];\n            results.push(r(err));\n          }\n          this.init(this.status);\n          return results;\n        });\n      }\n      return p;\n    });\n  }\n}\n\nexport default function (opts) {\n  const cache = lruCache(opts);\n  cache.getAsync = function getAsync(key, fetchFunction) {\n    let item;\n    item = cache.get(key);\n    if (item === undefined && fetchFunction) {\n      // Create a new cache item\n      item = new CacheItem({\n        key,\n        fetchFunction,\n      });\n      cache.set(key, item);\n    }\n    if (!(item instanceof CacheItem)) {\n      return Promise.resolve(item);\n    }\n    return item.fetch();\n  };\n  return cache;\n}\n","import Jimp from 'jimp';\n\nimport dataUriToBuffer from 'data-uri-to-buffer';\n\nimport QRCode from 'qrcode';\n\nimport pathModule from 'path';\n\nimport cachePromise from './cache-promise';\n\n\nfunction createImageFromDataUri(dataUri) {\n  return new Promise((res) => {\n    new Jimp(dataUriToBuffer(dataUri), ((err, img) => { // eslint-disable-line\n      if (err) throw err;\n      res(img);\n    }));\n  });\n}\n\nfunction createQRCode(data, opt = { errorCorrectionLevel: 'M', margin: 2 }) {\n  // FIXME: it works. But it could be more efficient.\n  // The npm qrcode module cannot output just a buffer.\n  // So we need to pass through base64 encoding.\n  // To fix this, we need to create a PR on qrcode to support output as a buffer.\n  return new Promise((res) => {\n    QRCode.toDataURL(data, opt, (err, response) => {\n      if (err) throw err;\n      res(createImageFromDataUri(response));\n    });\n  });\n}\n\n// TODO: Configurable cache params\nexport const cacheLogo = cachePromise();\nexport const cacheLogoResized = cachePromise();\n\nfunction fetchLogo(_logoPath) {\n  const logoPath = _logoPath[0] === '/' || _logoPath[0] === '\\\\' ? _logoPath : pathModule.resolve(__dirname, _logoPath);\n  return Jimp.read(logoPath);\n}\n\nfunction resizeSquared(img, _w, _h) {\n  let w;\n  let h;\n\n  if (_h > _w) {\n    w = Jimp.AUTO;\n    h = _h;\n  } else {\n    w = _w;\n    h = Jimp.AUTO;\n  }\n  return img.resize(w, h);\n}\n\nfunction getResizedLogo({\n  path, w, h, ignoreCache = false,\n}) {\n  if (ignoreCache) {\n    return fetchLogo(path).then(img => resizeSquared(img, w, h));\n  }\n\n  const resizedLogoKey = `${w}x${h}-${path}`;\n  return cacheLogoResized.getAsync(resizedLogoKey, async () => {\n    const logoFullImg = await cacheLogo.getAsync(path, () => fetchLogo(path));\n    return resizeSquared(logoFullImg.clone(), w, h);\n  });\n}\n\nexport default async function generate({\n  text, path, opt, ignoreCache, ratio = 2,\n}) {\n  const img = await createQRCode(text, opt);\n  const logo = await getResizedLogo({\n    path,\n    w: Math.floor(img.bitmap.width / ratio),\n    h: Math.floor(img.bitmap.height / ratio),\n    ignoreCache,\n  });\n\n  // Center the logo\n  const x = Math.floor((img.bitmap.width - logo.bitmap.width) / 2);\n  const y = Math.floor((img.bitmap.height - logo.bitmap.height) / 2);\n\n  // Apply on the QRCode\n  const qrImg = img.composite(logo, x, y);\n\n  return new Promise((res, rej) => {\n    qrImg.getBuffer(Jimp.MIME_PNG, (err, buf) => {\n      if (err) return rej(err);\n      return res(buf);\n    });\n  });\n}\n","import l from 'loglevel';\n\nimport generate from './generate';\n\nfunction defaultErrorFunction(req, res, err) {\n  l.error(err.stack || new Error(err.error || err).stack);\n  res.status(404).send('Not found');\n}\n\nexport default function factoryQrRequest({\n  text,\n  getText = !text && (req => req.query.t), // default text for the QRcode is in /?t=...\n  getLogoPath,\n  logoPath,\n  getRatio,\n  ignoreCache,\n  qrOpt,\n  getQrOpt,\n  maxAge = 31557600,\n  onError = defaultErrorFunction,\n} = {}) {\n  return async function qrRequest(req, res) {\n    let actualText = text;\n    let actualLogoPath = logoPath;\n    let actualQrOpt = qrOpt;\n\n    if (getText) {\n      try {\n        actualText = await getText(req);\n      } catch (err) {\n        return (onError || defaultErrorFunction)(req, res, { error: 'GETTEXT-EXCEPTION' });\n      }\n    }\n\n    if (getLogoPath) {\n      try {\n        actualLogoPath = await getLogoPath(req);\n      } catch (err) {\n        return (onError || defaultErrorFunction)(req, res, { error: 'GETLOGOPATH-EXCEPTION' });\n      }\n    }\n\n    if (getQrOpt) {\n      try {\n        actualQrOpt = await getQrOpt(req);\n      } catch (err) {\n        return (onError || defaultErrorFunction)(req, res, { error: 'GETQROPT-EXCEPTION' });\n      }\n    }\n\n    if (!actualText) {\n      return (onError || defaultErrorFunction)(req, res, { error: 'NOTEXT' });\n    }\n\n    if (!actualLogoPath) {\n      return (onError || defaultErrorFunction)(req, res, { error: 'NOLOGOPATH' });\n    }\n\n    return generate({\n      text: actualText,\n      path: actualLogoPath,\n      ratio: getRatio ? await getRatio(req) : 2,\n      opt: actualQrOpt,\n      ignoreCache,\n    }).then((imgBuffer) => {\n      res.setHeader('Content-Type', 'image/png');\n      if (maxAge !== false) res.setHeader('Cache-Control', `public, max-age=${maxAge}`);\n      res.send(imgBuffer);\n    }).catch((err) => {\n      (onError || defaultErrorFunction)(req, res, { error: err });\n    });\n  };\n}\n"],"names":["STATUS","CacheItem","opts","key","value","fetchFunction","init","status","initialized","resolvers","rejectors","Promise","resolve","then","fetchFailed","fetched","p","reject","push","fetching","ref","results","i","len","length","r","catch","err","cache","lruCache","getAsync","item","get","undefined","set","fetch","createImageFromDataUri","dataUri","res","Jimp","dataUriToBuffer","img","createQRCode","data","opt","errorCorrectionLevel","margin","toDataURL","response","cacheLogo","cachePromise","cacheLogoResized","fetchLogo","_logoPath","logoPath","pathModule","__dirname","read","resizeSquared","_w","_h","w","h","AUTO","resize","getResizedLogo","path","ignoreCache","resizedLogoKey","logoFullImg","clone","text","ratio","Math","floor","bitmap","width","height","logo","composite","x","y","rej","getBuffer","MIME_PNG","buf","generate","defaultErrorFunction","req","error","stack","Error","send","factoryQrRequest","getText","query","t","getLogoPath","getRatio","qrOpt","getQrOpt","maxAge","onError","actualText","actualLogoPath","actualQrOpt","imgBuffer","setHeader","qrRequest"],"mappings":"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"}