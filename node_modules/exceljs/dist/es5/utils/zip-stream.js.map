{"version":3,"sources":["../../../lib/utils/zip-stream.js"],"names":["events","require","JSZip","PromiseLib","StreamBuf","ZipReader","options","count","jsZip","stream","on","_process","getEntryType","Promise","resolve","then","emit","content","read","loadAsync","zip","forEach","path","entry","dir","async","data","entryStream","write","autodrain","_finished","error","encoding","callback","cork","uncork","end","EventEmitter","ZipWriter","Object","assign","type","compression","hasOwnProperty","base64","file","name","generateAsync","size","setEncoding","pause","resume","isPaused","destination","pipe","unpipe","chunk","unshift","wrap","module","exports"],"mappings":"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","sourcesContent":["const events = require('events');\nconst JSZip = require('jszip');\nconst PromiseLib = require('./promise');\n\nconst StreamBuf = require('./stream-buf');\n\n// The purpose of this module is to wrap the js-zip library into a streaming zip library\n// since most of the exceljs code uses streams.\n// One day I might find (or build) a properly streaming browser safe zip lib\n\n\n// =============================================================================\n// The ZipReader class\n// Unpacks an incoming zip stream\nclass ZipReader extends events.EventEmitter {\n  constructor(options) {\n    super();\n\n    this.count = 0;\n    this.jsZip = new JSZip();\n    this.stream = new StreamBuf();\n    this.stream.on('finish', () => {\n      this._process();\n    });\n    this.getEntryType = options.getEntryType || (() => 'string');\n  };\n\n  _finished() {\n    if (!--this.count) {\n      PromiseLib.Promise.resolve().then(() => {\n        this.emit('finished');\n      });\n    }\n  }\n\n  _process() {\n    const content = this.stream.read();\n    this.jsZip\n      .loadAsync(content)\n      .then(zip => {\n        zip.forEach((path, entry) => {\n          if (!entry.dir) {\n            this.count++;\n            entry\n              .async(this.getEntryType(path))\n              .then(data => {\n                const entryStream = new StreamBuf();\n                entryStream.path = path;\n                entryStream.write(data);\n                entryStream.autodrain = () => {\n                  this._finished();\n                };\n                entryStream.on('finish', () => {\n                  this._finished();\n                });\n\n                this.emit('entry', entryStream);\n              })\n              .catch(error => {\n                this.emit('error', error);\n              });\n          }\n        });\n      })\n      .catch(error => {\n        this.emit('error', error);\n      });\n  }\n\n  // ==========================================================================\n  // Stream.Writable interface\n  write(data, encoding, callback) {\n    if (this.error) {\n      if (callback) {\n        callback(this.error);\n      }\n      throw this.error;\n    } else {\n      return this.stream.write(data, encoding, callback);\n    }\n  }\n\n  cork() {\n    return this.stream.cork();\n  }\n\n  uncork() {\n    return this.stream.uncork();\n  }\n\n  end() {\n    return this.stream.end();\n  }\n\n  destroy(error) {\n    this.emit('finished');\n    this.error = error;\n  }\n}\n\n// =============================================================================\n// The ZipWriter class\n// Packs streamed data into an output zip stream\nclass ZipWriter extends events.EventEmitter {\n  constructor(options) {\n    super();\n    this.options = Object.assign({\n      type: 'nodebuffer',\n      compression: 'DEFLATE',\n    }, options);\n\n    this.zip = new JSZip();\n    this.stream = new StreamBuf();\n  };\n\n  append(data, options) {\n    if (options.hasOwnProperty('base64') && options.base64) {\n      this.zip.file(options.name, data, {base64: true});\n    } else {\n      this.zip.file(options.name, data);\n    }\n  }\n\n  finalize() {\n    return this.zip.generateAsync(this.options).then(content => {\n      this.stream.end(content);\n      this.emit('finish');\n    });\n  }\n\n  // ==========================================================================\n  // Stream.Readable interface\n  read(size) {\n    return this.stream.read(size);\n  }\n\n  setEncoding(encoding) {\n    return this.stream.setEncoding(encoding);\n  }\n\n  pause() {\n    return this.stream.pause();\n  }\n\n  resume() {\n    return this.stream.resume();\n  }\n\n  isPaused() {\n    return this.stream.isPaused();\n  }\n\n  pipe(destination, options) {\n    return this.stream.pipe(\n      destination,\n      options\n    );\n  }\n\n  unpipe(destination) {\n    return this.stream.unpipe(destination);\n  }\n\n  unshift(chunk) {\n    return this.stream.unshift(chunk);\n  }\n\n  wrap(stream) {\n    return this.stream.wrap(stream);\n  }\n}\n\n// =============================================================================\n\nmodule.exports = {\n  ZipReader,\n  ZipWriter,\n};\n"],"file":"zip-stream.js"}